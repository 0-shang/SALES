<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales Master Pro 3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e3a8a',
                        secondary: '#3b82f6',
                        accent: '#f59e0b',
                        danger: '#ef4444'
                    }
                }
            }
        }
    </script>
    <style>
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-closed { transform: translateX(100%); }
        .sidebar-open { transform: translateX(0); }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #bbb; border-radius: 3px; }
        /* ÊãñÂä®ÊåâÈíÆÊ†∑Âºè */
        #draggableBtn {
            touch-action: none; /* Èò≤Ê≠¢ÊâãÊú∫Á´ØÊãñÂä®Êó∂Ëß¶ÂèëÊªöÂä® */
            cursor: grab;
        }
        #draggableBtn:active { cursor: grabbing; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-screen overflow-hidden flex flex-col">

    <!-- A. ÁôªÂΩïÁïåÈù¢ -->
    <div id="loginSection" class="fixed inset-0 z-50 bg-primary flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-gray-50 p-8 text-center border-b border-gray-100">
                <i class="fa-solid fa-user-shield text-4xl text-primary mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800">Sales Login</h2>
            </div>
            <div class="p-8 space-y-6">
                <div id="loginStatus" class="hidden text-sm text-center p-2 rounded bg-red-50 text-red-600"></div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rep Code</label>
                    <input type="text" id="loginRepCode" placeholder="Enter Code (e.g. REP01)" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none uppercase">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-primary outline-none">
                </div>
                <button onclick="handleLogin()" class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-blue-900 transition">LOGIN</button>
                <p class="text-center text-xs text-gray-400 mt-4">System syncs with customers.csv</p>
            </div>
        </div>
    </div>

    <!-- B. ‰∏ªÁïåÈù¢ -->
    <div id="appSection" class="flex flex-col h-full hidden">
        
        <!-- È°∂ÈÉ®Ê†è -->
        <header class="bg-white border-b border-gray-200 shadow-sm z-20">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="bg-primary text-white w-10 h-10 rounded-lg flex items-center justify-center font-bold text-xl">SM</div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-800">SALES MASTER</h1>
                        <p class="text-xs text-green-600 font-semibold" id="welcomeUserText">...</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="toggleWeeklyReport()" class="text-gray-500 hover:text-accent transition flex flex-col items-center">
                        <i class="fa-solid fa-chart-line text-lg"></i>
                        <span class="text-[10px]">Insights</span>
                    </button>
                    <button onclick="logout()" class="text-red-400 hover:text-red-600 ml-2">
                        <i class="fa-solid fa-power-off text-lg"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- ÂÜÖÂÆπÂå∫Âüü -->
        <div class="flex flex-1 overflow-hidden relative">
            <main class="flex-1 overflow-y-auto p-4 md:p-8 relative bg-gray-50">
                
                <!-- 1. È¶ñÈ°µÂ§ßÊêúÁ¥¢ -->
                <div class="max-w-4xl mx-auto mt-6">
                    <div class="relative max-w-2xl mx-auto">
                        <input type="text" id="mainSearchInput" placeholder="Search Customer Name or Code..." 
                            class="w-full pl-6 pr-14 py-4 rounded-full shadow-lg border-none focus:ring-2 focus:ring-accent outline-none text-lg"
                            oninput="handleMainSearch(this.value)">
                        <i class="fa-solid fa-search absolute right-5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div id="mainSearchResult" class="mt-6 hidden max-w-2xl mx-auto"></div>
                </div>

                <!-- 2. ‰ªäÊó•‰ªªÂä°ÂàóË°® -->
                <div class="max-w-5xl mx-auto mt-12 pb-24">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800 border-l-4 border-accent pl-3">Today's Task</h3>
                        <button onclick="shareTaskToGroup()" class="text-sm bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center">
                            <i class="fa-brands fa-whatsapp mr-2"></i> Share Plan
                        </button>
                    </div>
                    <div id="todayTaskList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <!-- Â°´ÂÜôÊó•Êä•ÊåâÈíÆ (ÊÇ¨ÊµÆ) -->
                <div class="fixed bottom-8 right-8 z-10">
                    <button onclick="openReportModal()" class="bg-primary hover:bg-blue-900 text-white w-16 h-16 rounded-full shadow-2xl flex items-center justify-center transition transform hover:scale-110">
                        <i class="fa-solid fa-pen-to-square text-2xl"></i>
                    </button>
                </div>
            </main>

            <!-- ÊîπËøõÂª∫ËÆÆ2ÔºöÂèØÊãñÂä®ÁöÑ‰æßËæπÊ†èÊåâÈíÆ -->
            <button id="draggableBtn" class="fixed right-0 top-1/2 bg-white text-primary p-3 rounded-l-xl shadow-lg border border-r-0 border-gray-100 hover:bg-gray-50 z-30 w-12 h-14 flex items-center justify-center">
                <i class="fa-solid fa-chevron-left text-xl pointer-events-none"></i>
            </button>

            <!-- ‰æßËæπÊ†è (ÈÄâÊã©ÂÆ¢Êà∑) -->
            <div id="taskSidebar" class="sidebar sidebar-closed fixed right-0 top-0 h-full w-80 bg-white shadow-2xl z-40 flex flex-col">
                <div class="p-4 bg-primary text-white flex justify-between items-center">
                    <h3 class="font-bold">Select Customers</h3>
                    <button onclick="toggleSidebar()"><i class="fa-solid fa-times text-lg"></i></button>
                </div>
                <div class="p-3 bg-gray-50 border-b">
                    <input type="text" placeholder="Filter list..." class="w-full p-2 text-sm border rounded" oninput="filterSidebarList(this.value)">
                </div>
                <div id="customerSidebarList" class="flex-1 overflow-y-auto p-2 space-y-2 pb-20"></div>
            </div>
        </div>
    </div>

    <!-- C. Êó•Êä• Modal -->
    <div id="reportModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-4xl h-5/6 rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-700">Daily Visit Report</h3>
                <button onclick="closeReportModal()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <div class="bg-blue-50 text-blue-800 p-3 rounded text-sm mb-4 flex items-center">
                    <i class="fa-solid fa-circle-info mr-2"></i>
                    Today's tasks added automatically.
                </div>
                <div class="space-y-4" id="reportRows"></div>
                <button onclick="addReportRow()" class="mt-6 w-full py-3 border-2 border-dashed border-gray-300 text-gray-500 rounded-lg hover:border-primary hover:text-primary font-bold">
                    <i class="fa-solid fa-plus mr-1"></i> Add Another Customer
                </button>
            </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end">
                <button onclick="submitReport()" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-lg font-bold shadow-md flex items-center">
                    <i class="fa-solid fa-paper-plane mr-2"></i> Submit & Send
                </button>
            </div>
        </div>
    </div>

    <!-- D. Insights / Monthly History Modal -->
    <div id="weeklyReportModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex justify-center items-center p-4">
        <div class="bg-white w-full max-w-4xl h-[90vh] rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <!-- Modal Header -->
            <div class="p-5 bg-white border-b flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Performance</h2>
                    <div class="flex space-x-6 mt-2 text-sm">
                        <button onclick="switchInsightTab('week')" id="tabWeek" class="text-primary font-bold border-b-2 border-primary pb-1">This Week</button>
                        <!-- ÊîπËøõÂª∫ËÆÆ1: ÊòéÁ°Æ‰∏∫ Monthly History -->
                        <button onclick="switchInsightTab('history')" id="tabHistory" class="text-gray-500 hover:text-primary pb-1">Monthly History</button>
                    </div>
                </div>
                <button onclick="toggleWeeklyReport()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-2xl"></i></button>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto p-6 bg-gray-50">
                
                <!-- 1. Êú¨Âë®ËßÜÂõæ -->
                <div id="viewWeek" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white p-4 rounded shadow border-l-4 border-blue-500">
                            <div class="text-gray-500 text-xs uppercase">Visits This Week</div>
                            <div class="text-2xl font-bold" id="weekVisitCount">0</div>
                        </div>
                        <div class="bg-white p-4 rounded shadow border-l-4 border-green-500">
                            <div class="text-gray-500 text-xs uppercase">Coverage %</div>
                            <div class="text-2xl font-bold" id="weekCoverage">0%</div>
                        </div>
                        <div class="bg-white p-4 rounded shadow border-l-4 border-red-500">
                            <div class="text-gray-500 text-xs uppercase">Missed Customers</div>
                            <div class="text-2xl font-bold" id="weekMissedCount">0</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded shadow p-4">
                            <h4 class="font-bold text-green-700 mb-3 border-b pb-2">‚úÖ Visited This Week</h4>
                            <ul id="weekVisitedList" class="text-sm space-y-1 text-gray-600 max-h-60 overflow-y-auto"></ul>
                        </div>
                        <div class="bg-white rounded shadow p-4">
                            <h4 class="font-bold text-red-600 mb-3 border-b pb-2">‚ùå Not Visited This Week</h4>
                            <ul id="weekMissedList" class="text-sm space-y-1 text-gray-600 max-h-60 overflow-y-auto"></ul>
                        </div>
                    </div>
                </div>

                <!-- 2. ÊúàÂ∫¶ÂéÜÂè≤ËßÜÂõæ (ÊîπËøõÁÇπ1: ‰ºòÂåñÊâãÊú∫ÊòæÁ§∫ & ÊúàÂ∫¶ÈÄªËæë) -->
                <div id="viewHistory" class="hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-2">
                        <div>
                            <p class="text-lg font-bold text-gray-800" id="currentMonthTitle">December Statistics</p>
                            <p class="text-xs text-gray-500">Data resets automatically on the 1st of every month.</p>
                        </div>
                        <button onclick="exportHistoryToCSV()" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 text-sm w-full md:w-auto">
                            <i class="fa-solid fa-file-csv mr-2"></i> Export Monthly Data
                        </button>
                    </div>
                    
                    <!-- ÊâãÊú∫Á´Ø‰ºòÂåñÁöÑÂàóË°®ÊòæÁ§∫ (‰ª£ÊõøË°®Ê†º) -->
                    <div class="space-y-3" id="historyListContainer">
                        <!-- JSÂ°´ÂÖÖ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Logic -->
    <script>
        let allSalesData = [];
        let myCustomers = [];
        let currentUser = null;
        let todayTasks = [];

        window.onload = function() {
            loadCSV();
            initDraggable(); // ÂàùÂßãÂåñÊãñÂä®ÊåâÈíÆ
        };

        // --- ÊîπËøõÂª∫ËÆÆ2: ÊãñÂä®ÊåâÈíÆÈÄªËæë ---
        function initDraggable() {
            const btn = document.getElementById("draggableBtn");
            let isDragging = false;
            let startY, startTop;

            const onTouchStart = (e) => {
                isDragging = false;
                const touch = e.touches ? e.touches[0] : e;
                startY = touch.clientY;
                startTop = btn.offsetTop;
                // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨
                document.addEventListener('mousemove', onTouchMove);
                document.addEventListener('mouseup', onTouchEnd);
                document.addEventListener('touchmove', onTouchMove, {passive: false});
                document.addEventListener('touchend', onTouchEnd);
            };

            const onTouchMove = (e) => {
                const touch = e.touches ? e.touches[0] : e;
                const deltaY = touch.clientY - startY;
                
                // Â¶ÇÊûúÁßªÂä®Ë∂ÖËøá5ÂÉèÁ¥†ÔºåËßÜ‰∏∫ÊãñÂä®
                if (Math.abs(deltaY) > 5) isDragging = true;
                if (!isDragging) return;

                e.preventDefault(); // Èò≤Ê≠¢ÊªöÂä®
                let newTop = startTop + deltaY;
                
                // ÈôêÂà∂ËåÉÂõ¥
                const maxTop = window.innerHeight - 60;
                if (newTop < 50) newTop = 50;
                if (newTop > maxTop) newTop = maxTop;
                
                btn.style.top = newTop + "px";
            };

            const onTouchEnd = () => {
                document.removeEventListener('mousemove', onTouchMove);
                document.removeEventListener('mouseup', onTouchEnd);
                document.removeEventListener('touchmove', onTouchMove);
                document.removeEventListener('touchend', onTouchEnd);
            };

            // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂ÔºåÂå∫ÂàÜÁÇπÂáªÂíåÊãñÂä®
            btn.addEventListener('mousedown', onTouchStart);
            btn.addEventListener('touchstart', onTouchStart);
            
            btn.onclick = (e) => {
                if (isDragging) {
                    e.preventDefault();
                    isDragging = false;
                } else {
                    toggleSidebar();
                }
            };
        }

        // --- 1. Login & Data ---
        function loadCSV() {
            Papa.parse("customers.csv", {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    allSalesData = results.data.map(item => ({
                        id: (item.Code || item.code || "").trim(),
                        name: (item.Name || item.name || "Unknown").trim(),
                        repName: (item.RepName || item.repname || "Sales").trim(),
                        repCode: (item.Limit || item.limit || "").trim().toUpperCase(), 
                        phone: (item.Phone || item.phone || "").trim(),
                        credit: (item.Credit || item.credit || "0").trim()
                    }));
                }
            });
        }

        function handleLogin() {
            const code = document.getElementById('loginRepCode').value.trim().toUpperCase();
            const pass = document.getElementById('loginPassword').value.trim();
            const status = document.getElementById('loginStatus');
            
            if (pass !== '0000') { status.innerText = "Wrong Password"; status.classList.remove('hidden'); return; }
            const customers = allSalesData.filter(c => c.repCode === code);
            if (customers.length === 0) { status.innerText = "No customers found"; status.classList.remove('hidden'); return; }

            myCustomers = customers;
            currentUser = { code: code, name: customers[0].repName };
            
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('appSection').classList.remove('hidden');
            document.getElementById('welcomeUserText').innerText = `Welcome, ${currentUser.name}`;
            
            loadCustomersToSidebar(myCustomers);
            loadTasksFromStorage(); // ËøôÈáåÂåÖÂê´ÊîπËøõÂª∫ËÆÆ3
        }

        function logout() { location.reload(); }

        // --- 2. ÊêúÁ¥¢ & ÁîµËØù ---
        function handleMainSearch(query) {
            const container = document.getElementById('mainSearchResult');
            if (query.length < 2) { container.classList.add('hidden'); return; }
            
            const res = myCustomers.find(c => c.name.toLowerCase().includes(query.toLowerCase()) || c.id.toLowerCase().includes(query.toLowerCase()));
            container.classList.remove('hidden');
            
            if (res) {
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 flex flex-col md:flex-row justify-between items-center animate-fade-in-up">
                        <div class="mb-4 md:mb-0 text-left">
                            <h3 class="text-xl font-bold text-primary">${res.name}</h3>
                            <div class="text-sm text-gray-500 mt-2 space-y-1">
                                <div><i class="fa-solid fa-id-badge mr-2 w-5"></i> ${res.id}</div>
                                <div>
                                    <a href="tel:${res.phone}" class="text-blue-600 hover:underline font-bold">
                                        <i class="fa-solid fa-phone mr-2 w-5"></i> ${res.phone}
                                    </a>
                                </div>
                                <div><i class="fa-solid fa-wallet mr-2 w-5"></i> Limit: ${res.credit}</div>
                            </div>
                        </div>
                        <button onclick="requestStatement('${res.name}', '${res.id}')" class="bg-green-100 text-green-700 px-5 py-2 rounded-lg font-bold hover:bg-green-200 transition">
                            <i class="fa-brands fa-whatsapp mr-2"></i> Statement
                        </button>
                    </div>`;
            } else {
                container.innerHTML = `<div class="bg-white p-4 rounded-xl text-center text-gray-400">Not Found</div>`;
            }
        }
        
        function requestStatement(name, code) {
            window.open(`https://wa.me/233550584720?text=${encodeURIComponent(`I want statement of ${name} (${code})`)}`, '_blank');
        }

        // --- 3. Sidebar & Task ---
        function toggleSidebar() {
            const sb = document.getElementById('taskSidebar');
            sb.classList.toggle('sidebar-closed');
            sb.classList.toggle('sidebar-open');
        }

        function loadCustomersToSidebar(data) {
            const list = document.getElementById('customerSidebarList');
            list.innerHTML = '';
            data.slice(0, 100).forEach(c => {
                const item = document.createElement('div');
                item.className = "flex justify-between items-center bg-white p-3 rounded border hover:shadow cursor-pointer";
                item.innerHTML = `
                    <div><div class="font-bold text-gray-700 text-sm">${c.name}</div><div class="text-xs text-gray-400">${c.id}</div></div>
                    <button onclick="addToTask('${c.id}')" class="text-gray-300 hover:text-green-500"><i class="fa-solid fa-plus-circle text-xl"></i></button>`;
                list.appendChild(item);
            });
        }
        
        function filterSidebarList(q) {
            const filtered = myCustomers.filter(c => c.name.toLowerCase().includes(q.toLowerCase()));
            loadCustomersToSidebar(filtered);
        }

        function addToTask(id) {
            if (!todayTasks.some(t => t.id === id)) {
                todayTasks.push(myCustomers.find(c => c.id === id));
                saveTasks(); renderTasks();
            }
        }

        function renderTasks() {
            const box = document.getElementById('todayTaskList');
            box.innerHTML = '';
            todayTasks.forEach(t => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg shadow-sm border relative group";
                card.innerHTML = `
                    <h4 class="font-bold text-gray-800">${t.name}</h4>
                    <a href="tel:${t.phone}" class="text-xs text-blue-500 hover:underline block my-1"><i class="fa-solid fa-phone"></i> ${t.phone}</a>
                    <button onclick="removeFromTask('${t.id}')" class="absolute top-2 right-2 text-gray-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                `;
                box.appendChild(card);
            });
        }
        
        function removeFromTask(id) { todayTasks = todayTasks.filter(t => t.id !== id); saveTasks(); renderTasks(); }
        
        // --- ÊîπËøõÂª∫ËÆÆ3: Ëá™Âä®Ê∏ÖÈô§‰ªªÂä° ---
        function saveTasks() { 
            if(currentUser) {
                // ‰øùÂ≠ò‰ªªÂä°ÁöÑÂêåÊó∂‰øùÂ≠ò‰ªäÂ§©ÁöÑÊó•Êúü
                const data = {
                    date: new Date().toLocaleDateString(), // Ê†ºÂºèÂ¶Ç "12/1/2025"
                    tasks: todayTasks
                };
                localStorage.setItem(`tasks_${currentUser.code}`, JSON.stringify(data)); 
            }
        }

        function loadTasksFromStorage() { 
            if(currentUser) {
                const raw = localStorage.getItem(`tasks_${currentUser.code}`);
                if(raw) {
                    const data = JSON.parse(raw);
                    const todayStr = new Date().toLocaleDateString();
                    
                    // Ê£ÄÊü•Êó•ÊúüÔºöÂ¶ÇÊûú‰øùÂ≠òÁöÑÊó•Êúü‰∏çÊòØ‰ªäÂ§©ÔºåÂàôÊ∏ÖÁ©∫
                    if (data.date === todayStr) {
                        todayTasks = data.tasks || [];
                    } else {
                        todayTasks = []; // Êñ∞ÁöÑ‰∏ÄÂ§©ÔºåËá™Âä®Ê∏ÖÈô§
                        saveTasks(); // Êõ¥Êñ∞Â≠òÂÇ®‰∏∫Á©∫
                    }
                } else {
                    todayTasks = [];
                }
                renderTasks();
            }
        }
        
        function shareTaskToGroup() {
            if(todayTasks.length === 0) return alert("Task list is empty");
            let msg = `*üìÖ ${currentUser.name}'s PLAN*\n${new Date().toLocaleDateString()}\n`;
            todayTasks.forEach((t, i) => msg += `${i+1}. ${t.name}\n`);
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // --- 4. Report ---
        function openReportModal() {
            const modal = document.getElementById('reportModal');
            const container = document.getElementById('reportRows');
            modal.classList.remove('hidden');
            container.innerHTML = ''; 

            if (todayTasks.length > 0) {
                todayTasks.forEach(task => addReportRow(task));
            } else {
                addReportRow(); 
            }
        }
        function closeReportModal() { document.getElementById('reportModal').classList.add('hidden'); }

        function addReportRow(prefillData = null) {
            const id = Date.now() + Math.random();
            const div = document.createElement('div');
            div.id = `row-${id}`;
            div.className = "bg-gray-50 p-4 rounded border relative";
            const custName = prefillData ? prefillData.name : "";
            const custId = prefillData ? prefillData.id : "";

            div.innerHTML = `
                <button onclick="document.getElementById('row-${id}').remove()" class="absolute right-2 top-2 text-gray-300 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="relative">
                        <label class="text-xs font-bold text-gray-400">CUSTOMER</label>
                        <input type="text" value="${custName}" class="w-full p-2 border rounded mt-1 bg-white" placeholder="Search..." onkeyup="searchRepCust(this, '${id}')">
                        <div id="res-${id}" class="absolute z-10 bg-white w-full max-h-40 overflow-auto shadow hidden rounded border"></div>
                        <input type="hidden" id="vid-${id}" class="r-id" value="${custId}">
                        <input type="hidden" id="vnm-${id}" class="r-nm" value="${custName}">
                    </div>
                    <div class="md:col-span-2">
                        <label class="text-xs font-bold text-gray-400">OUTCOME</label>
                        <input type="text" class="r-note w-full p-2 border rounded mt-1 bg-white" placeholder="Result...">
                    </div>
                </div>`;
            document.getElementById('reportRows').appendChild(div);
        }

        function searchRepCust(inp, id) {
            const val = inp.value.toLowerCase();
            const box = document.getElementById(`res-${id}`);
            if(val.length<1) { box.classList.add('hidden'); return; }
            box.innerHTML = ''; box.classList.remove('hidden');
            myCustomers.filter(c=>c.name.toLowerCase().includes(val)).slice(0,5).forEach(c=>{
                const d = document.createElement('div');
                d.className="p-2 hover:bg-blue-50 cursor-pointer border-b text-sm";
                d.innerText=c.name;
                d.onclick=()=>{ 
                    inp.value=c.name; 
                    document.getElementById(`vid-${id}`).value=c.id; 
                    document.getElementById(`vnm-${id}`).value=c.name; 
                    box.classList.add('hidden'); 
                };
                box.appendChild(d);
            });
        }

        function submitReport() {
            const rows = document.querySelectorAll('.r-id');
            let txt = `*üìù REPORT - ${currentUser.name}*\n${new Date().toLocaleDateString()}\n\n`;
            let history = [];
            let hasData = false;

            rows.forEach(r => {
                const rowId = r.id.split('-')[1];
                const nm = document.getElementById(`vnm-${rowId}`).value;
                const note = r.parentElement.parentElement.parentElement.querySelector('.r-note').value;
                if(nm && note) {
                    txt += `üìç *${nm}*\n   ‚îî ${note}\n`;
                    history.push({ date: new Date().toISOString(), customerId: r.value, customerName: nm, note: note });
                    hasData = true;
                }
            });

            if(!hasData) return alert("Fill report details");
            saveHistory(history);
            window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
            closeReportModal();
        }

        function saveHistory(newItems) {
            const key = `hist_${currentUser.code}`;
            let h = JSON.parse(localStorage.getItem(key) || "[]");
            h = h.concat(newItems);
            localStorage.setItem(key, JSON.stringify(h));
        }

        // --- 5. Insights & Monthly History ---
        function toggleWeeklyReport() {
            const m = document.getElementById('weeklyReportModal');
            if(m.classList.contains('hidden')) {
                m.classList.remove('hidden');
                switchInsightTab('week'); 
            } else {
                m.classList.add('hidden');
            }
        }

        function switchInsightTab(tab) {
            const viewWeek = document.getElementById('viewWeek');
            const viewHist = document.getElementById('viewHistory');
            const tabWeek = document.getElementById('tabWeek');
            const tabHist = document.getElementById('tabHistory');

            if(tab === 'week') {
                viewWeek.classList.remove('hidden');
                viewHist.classList.add('hidden');
                tabWeek.className = "text-primary font-bold border-b-2 border-primary pb-1";
                tabHist.className = "text-gray-500 hover:text-primary pb-1";
                renderWeeklyStats();
            } else {
                viewWeek.classList.add('hidden');
                viewHist.classList.remove('hidden');
                tabWeek.className = "text-gray-500 hover:text-primary pb-1";
                tabHist.className = "text-primary font-bold border-b-2 border-primary pb-1";
                renderMonthlyStats(); // Êîπ‰∏∫ÊúàÂ∫¶Ê∏≤Êüì
            }
        }

        function getHistoryData() {
            return JSON.parse(localStorage.getItem(`hist_${currentUser.code}`) || "[]");
        }

        // Ëé∑ÂèñÂΩìÊúàÊï∞ÊçÆ (ÈÄªËæëÊ†∏ÂøÉ)
        function getMonthlyHistory() {
            const all = getHistoryData();
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); // 0-11

            return all.filter(item => {
                const d = new Date(item.date);
                return d.getFullYear() === currentYear && d.getMonth() === currentMonth;
            });
        }

        function renderWeeklyStats() {
            // ... (Êú¨Âë®ÈÄªËæë‰øùÊåÅ‰∏çÂèòÔºå‰æùÁÑ∂ÊúâÁî®)
            const allHistory = getHistoryData();
            const now = new Date();
            const day = now.getDay() || 7; 
            if(day !== 1) now.setHours(-24 * (day - 1)); 
            else now.setHours(0,0,0,0);
            const mondayTime = now.getTime(); 

            const visitedThisWeekIds = new Set(
                allHistory.filter(h => new Date(h.date).getTime() > mondayTime)
                          .map(h => h.customerId)
            );

            const visitedList = myCustomers.filter(c => visitedThisWeekIds.has(c.id));
            const missedList = myCustomers.filter(c => !visitedThisWeekIds.has(c.id));

            document.getElementById('weekVisitCount').innerText = visitedList.length;
            document.getElementById('weekMissedCount').innerText = missedList.length;
            document.getElementById('weekCoverage').innerText = Math.round((visitedList.length / myCustomers.length) * 100) + "%";

            const vList = document.getElementById('weekVisitedList');
            vList.innerHTML = visitedList.length ? '' : '<li class="text-gray-400 italic">No visits this week</li>';
            visitedList.forEach(c => vList.innerHTML += `<li>${c.name}</li>`);

            const mList = document.getElementById('weekMissedList');
            mList.innerHTML = '';
            missedList.forEach(c => mList.innerHTML += `<li>${c.name}</li>`);
        }

        // ÊîπËøõÂª∫ËÆÆ1: Ê∏≤ÊüìÊúàÂ∫¶ÂéÜÂè≤ (Card Layout for Mobile)
        function renderMonthlyStats() {
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const now = new Date();
            document.getElementById('currentMonthTitle').innerText = `${monthNames[now.getMonth()]} Statistics`;

            const monthlyData = getMonthlyHistory();
            const counts = {};
            monthlyData.forEach(h => { counts[h.customerId] = (counts[h.customerId] || 0) + 1; });

            const container = document.getElementById('historyListContainer');
            container.innerHTML = '';

            myCustomers.forEach(c => {
                const visitCount = counts[c.id] || 0;
                // Âç°ÁâáÊ†∑ÂºèÔºåÊâãÊú∫Á´ØÂèãÂ•Ω
                const card = document.createElement('div');
                // Êú™ÊãúËÆøÊòæÁ§∫Á∫¢Ëâ≤ËæπÊ°ÜÂíåËÉåÊôØ
                const isMissed = visitCount === 0;
                card.className = isMissed 
                    ? "bg-red-50 border-l-4 border-red-500 p-4 rounded shadow-sm flex justify-between items-center"
                    : "bg-white border-l-4 border-green-500 p-4 rounded shadow-sm flex justify-between items-center";

                card.innerHTML = `
                    <div class="overflow-hidden">
                        <div class="font-bold text-gray-800 text-base truncate pr-2">${c.name}</div>
                        <div class="text-sm text-gray-500 mt-1 flex items-center space-x-3">
                            <span>${c.id}</span>
                            <a href="tel:${c.phone}" class="text-blue-600"><i class="fa-solid fa-phone"></i> ${c.phone}</a>
                        </div>
                    </div>
                    <div class="flex-shrink-0 text-center ml-2">
                        <div class="${isMissed ? 'text-red-600' : 'text-green-600'} font-bold text-xl">${visitCount}</div>
                        <div class="text-[10px] text-gray-400 uppercase">Visits</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function exportHistoryToCSV() {
            const monthlyData = getMonthlyHistory();
            const counts = {};
            monthlyData.forEach(h => { counts[h.customerId] = (counts[h.customerId] || 0) + 1; });

            let csvContent = "data:text/csv;charset=utf-8,Code,Name,Phone,MonthVisits,Status\n";
            myCustomers.forEach(c => {
                const count = counts[c.id] || 0;
                const status = count === 0 ? "NOT VISITED" : "VISITED";
                csvContent += `${c.id},${c.name},${c.phone},${count},${status}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            const dateStr = new Date().toISOString().slice(0,7); // 2023-10
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Monthly_Stats_${currentUser.name}_${dateStr}.csv`);
            document.body.appendChild(link);
            link.click();
        }

    </script>
</body>
</html>